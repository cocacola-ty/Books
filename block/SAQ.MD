# SAQ - Block

## 为什么block是值捕获

block创建本质是调用了对应结构体的构造函数生成一个结构体实例

当执行构造函数时，会将外部变量此时的值赋值给结构体中对应的变量。

所以block中使用的外部变量的值是捕获创建block时该变量的值。

## 为什么block中不可以更改外部变量

block中使用的外部变量, 在block定义的时候就将外部变量赋值给自己结构体中的对应变量

后面在block中使用的这个外部变量其实是自己结构体中的变量。

所以当尝试在block中修改外部的变量时，编译器就会阻止这种操作。

## 为什么__block修饰的变量在block中可以修改值

`__block`修饰的变量通过`clang`转换成`c++`之后，成为了一个结构体

定义block时如果有使用到该变量，会将该变量对应的结构体的指针保存在block对应的结构体中

当修改该变量时，通过该变量对应的结构体指针去修改变量的值

## 为什么静态变量、全局变量、全局静态变量在block中可以修改值

全局变量和全局静态变量因为他们的作用域就是全局的，而block的实现部分经过转换为c++之后也是一个函数。在函数中可以修改全局变量的值

静态变量是因为如果block中使用到了静态变量，block对应的结构体中会定义一个该变量类型指针。执行结构体的构造函数时会将静态变量的地址赋值给这个指针。

当修改静态变量时，直接通过指针去对应地址进行修改

## 为什么静态变量可以通过保存变量指针去更改变量值，普通的局部变量不可以通过该方式

静态变量不会被释放

局部变量作用域结束就释放了，保存也没用。

## 为什么`__block`修饰的变量就可以通过指针去修改变量值，它不会在作用域结束之后释放吗

## 为什么block中的对象可以在对象作用域之外使用

## block存储在内存的什么区域

如果block定义在全局区，或block使用到了外部变量，那么block就定义在全局区

否则创建出来的block是在栈区

当创建出来的block以下情况时会自动将block复制到堆区

1. 指针引用

2. 调用copy方法

## `__block`修饰的变量存储在内存的什么区域

默认情况是在栈区

当block中使用到了这个变量时，并且block被复制到了堆区。这个变量也会被复制到堆区

## `__block`修饰对象

当block中使用到了对象时，是在block对应的结构体中增加了一个指针保存对象的地址。

而当用`__block`修饰时，无论是id类型还是基本数据类型，用`__block`修饰，都会转为一个结构体。然后在这个结构体中保存原来的变量值。
